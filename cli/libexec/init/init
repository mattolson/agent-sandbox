#!/usr/bin/env bash
set -euo pipefail

# shellcheck source=../../lib/logging.bash
source "$AGB_LIBDIR/logging.bash"
# shellcheck source=../../lib/require.bash
source "$AGB_LIBDIR/require.bash"
# shellcheck source=../../lib/select.bash
source "$AGB_LIBDIR/select.bash"
# shellcheck source=../../lib/constants.bash
source "$AGB_LIBDIR/constants.bash"
# shellcheck source=../../lib/path.bash
source "$AGB_LIBDIR/path.bash"

# Initializes agent-sandbox for a project.
#   - Prompts to select agent type (claude/copilot)
#   - Prompts to select mode (cli/devcontainer)
#   - Prompts to select IDE (code/jetbrains/none)
#   - Creates a network policy file
#   - Sets up the selected mode configuration files
init() {
	require yq

	local name=""
	local project_path=""

	while [[ $# -gt 0 ]]
	do
		case $1 in
		--name)
			name="$2"
			shift 2
			;;
		--path)
			project_path="$2"
			shift 2
			;;
		*)
			echo "Unknown option: $1" | error
			return 1
			;;
		esac
	done

	if [[ -z "$project_path" ]]
	then
		project_path="."
	fi

	if [[ ! -d "$project_path" ]]
	then
		echo "Directory does not exist: $project_path" | error
		return 1
	fi
	project_path=$(cd "$project_path" && pwd)

	echo "Configuring project at: $project_path" | info

	local available_agents=(claude copilot)
	local agent
	agent=$(select_option "Select agent:" "${available_agents[@]}")

	local available_modes=(cli devcontainer)
	local mode
	mode=$(select_option "Select mode:" "${available_modes[@]}")

	if [[ -z "$name" ]]
	then
		local default_name
		default_name=$(derive_project_name "$project_path" "$mode")
		name=$(read_line "Project name [$default_name]:")
		if [[ -z "$name" ]]
		then
			name="$default_name"
		fi
	fi

	local policy_file="$AGB_PROJECT_DIR/policy-$mode-$agent.yaml"

	case "$mode" in
	cli)
		policy "$project_path/$policy_file" "$agent"
		cli \
			--policy-file "$policy_file" \
			--project-path "$project_path" \
			--agent "$agent" \
			--name "$name"
		;;
	devcontainer)
		local available_ides=(vscode jetbrains none)
		local ide
		ide=$(select_option "Select IDE:" "${available_ides[@]}")

		local services=("$agent")
		if [[ "$ide" != "none" ]]
		then
			services+=("$ide")
		fi

		policy "$project_path/$policy_file" "${services[@]}"
		devcontainer \
			--policy-file "$policy_file" \
			--project-path "$project_path" \
			--agent "$agent" \
			--ide "$ide" \
			--name "$name"
		;;
	*)
		echo "Invalid mode selected: $mode" | error
		return 1
		;;
	esac
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
	init "$@"
fi
