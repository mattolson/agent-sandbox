#!/usr/bin/env bash
set -euo pipefail

# shellcheck source=../../lib/logging.bash
source "$AGB_LIBDIR/logging.bash"
# shellcheck source=../../lib/composefile.bash
source "$AGB_LIBDIR/composefile.bash"

# Sets up a Devcontainer configuration for an agent.
# Copies devcontainer template files and customizes the docker-compose.yml.
# Args:
#   $1 - The agent name (e.g., "claude")
#   $2 - Path to the project directory
#   $3 - Path to the policy file (relative to project directory)
devcontainer() {
	local agent=$1
	local project_path=$2
	local policy_file=$3

	local devcontainer_dir="$project_path/.devcontainer"
	local compose_file="$devcontainer_dir/docker-compose.yml"

	mkdir -p "$devcontainer_dir"
	cp -r \
		"$AGB_TEMPLATEDIR/$agent/devcontainer/"* \
		"$devcontainer_dir"

	local rel_policy_file="../$policy_file"

	customize_compose_file "$agent" "$rel_policy_file" "$compose_file"

	echo "Devcontainer dir created at $devcontainer_dir" | info

	: "${edit_compose_file:=$(select_yes_no "Edit the compose file?")}"
	if [[ $edit_compose_file == true  ]]
	then
		open_editor "$compose_file"
	fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
	devcontainer "$@"
fi
