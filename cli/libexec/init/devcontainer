#!/usr/bin/env bash
set -euo pipefail

# shellcheck source=../../lib/logging.bash
source "$AGB_LIBDIR/logging.bash"
# shellcheck source=../../lib/composefile.bash
source "$AGB_LIBDIR/composefile.bash"

# Sets up a Devcontainer configuration for an agent.
# Copies devcontainer template files and customizes the docker-compose.yml.
# Args:
#   $1 - Path to the policy file (relative to project directory)
#   $2 - Path to the project directory
#   $3 - The agent name (e.g., "claude")
#   $4 - The IDE name (e.g., "vscode", "jetbrains", "none") (optional)
devcontainer() {
	local policy_file=$1
	local project_path=$2
	local agent=$3
	local ide=${4:-}

	local devcontainer_dir="$project_path/.devcontainer"
	local compose_file="$devcontainer_dir/docker-compose.yml"

	mkdir -p "$devcontainer_dir"
	cp -r \
		"$AGB_TEMPLATEDIR/$agent/devcontainer/"* \
		"$devcontainer_dir"

	local rel_policy_file="../$policy_file"

	customize_compose_file "$rel_policy_file" "$compose_file" "$agent" "$ide"

	local project_name
	project_name=$(derive_project_name "$project_path" "devcontainer")
	set_project_name "$compose_file" "$project_name"

	echo "Devcontainer dir created at $devcontainer_dir" | info

	: "${edit_compose_file:=$(select_yes_no "Edit the compose file?")}"
	if [[ $edit_compose_file == true ]]
	then
		open_editor "$compose_file"
	fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
	devcontainer "$@"
fi
