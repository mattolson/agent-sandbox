#!/usr/bin/env bash
set -euo pipefail

# shellcheck source=../../lib/require.bash
source "$AGB_LIBDIR/require.bash"
# shellcheck source=../../lib/path.bash
source "$AGB_LIBDIR/path.bash"
# shellcheck source=../../lib/select.bash
source "$AGB_LIBDIR/select.bash"
# shellcheck source=../../lib/logging.bash
source "$AGB_LIBDIR/logging.bash"

# Opens the compose file in an editor and restarts docker compose if changes were made
edit() {
	local compose_file
	compose_file="$(find_compose_file)"

	local mtime_before
	mtime_before=$(get_file_mtime "$compose_file")

	open_editor "$compose_file"

	local mtime_after
	mtime_after=$(get_file_mtime "$compose_file")

	if [[ "$mtime_before" != "$mtime_after" ]]
	then
		echo "Compose file was modified. Restarting docker compose..." | info
		require docker
		docker compose -f "$compose_file" up -d
	else
		echo "No changes detected. Skipping restart." | warning
	fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]
then
	edit "$@"
fi
