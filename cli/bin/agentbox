#!/usr/bin/env bash

# Note: We first need to use POSIX's `[ ... ]` instead of Bash's `[[ ... ]]`
# because this is the check for Bash, where the shell may not be Bash.  Once we
# confirm that we are in Bash, we can use [[ ... ]] and (( ... )).  Note that
# these [[ ... ]] and (( ... )) do not cause syntax errors in POSIX shells,
# though they can be parsed differently.
# shellcheck disable=2292
if [ -z "${BASH_VERSION-}" ] ||
	[[ -z "${BASH_VERSINFO-}" ]] ||
	((BASH_VERSINFO[0] < 3 || (BASH_VERSINFO[0] == 3 && BASH_VERSINFO[1] < 2)))
then
	echo "$0: this program needs to be run by Bash >= 3.2" >&2
	exit 1
fi

set -euo pipefail

main() {
	AGB_ROOT="$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")/.."
	export AGB_ROOT
	export AGB_LIBDIR="$AGB_ROOT/lib"
	export AGB_LIBEXECDIR="$AGB_ROOT/libexec"
	export AGB_TEMPLATEDIR="$AGB_ROOT/templates"

	# shellcheck source=../lib/compat.bash
	source "$AGB_LIBDIR/compat.bash"

	local -a modules
	mapfile -t modules < <(
		find "$AGB_LIBEXECDIR" \
			-mindepth 1 \
			-maxdepth 1 \
			-type d \
			-print |
			while IFS= read -r
			do
				basename -- "$REPLY"
			done |
			sort
	)

	local -r usage="
Usage: agentbox <$(IFS='|'; echo "${modules[*]}")> [command] [args...]

Any other command is passed through to docker compose.
"

	if [[ $# -lt 1 ]]
	then
		echo "$usage" >&2
		exit 1
	fi

	local -r module="$1"
	shift 1

	# Check if module is a known module directory. If not, fall through to
	# docker compose with the original command as the first argument.
	#shellcheck disable=SC2076
	if [[ "$module" =~ [[:space:]] ]] ||
		! [[ " ${modules[*]} " =~ " $module " ]]
	then
		"$AGB_LIBEXECDIR/version/version" "Agent Sandbox"
		exec "$AGB_LIBDIR/run-compose" "$module" "$@"
	fi

	local command="${1:-}"
	if [[ -z "$command" || "${command:0:1}" == "-" ]]
	then
		command="$module"
	else
		shift 1
	fi

	if [[ "$command" == "help" ]]
	then
		echo "Commands in $module:" >&2
		find "$AGB_LIBEXECDIR/$module" \
			-maxdepth 1 \
			-type f \
			-perm +0100 \
			-print |
			while IFS= read -r
			do
				echo -n '  '
				basename -- "$REPLY"
			done |
			sort >&2
		exit 0
	fi

	local exec="$AGB_LIBEXECDIR/$module/$command"
	if ! [[ -x "$exec" ]]
	then
		exec="$AGB_LIBEXECDIR/$module/_"
		if ! [[ -x "$exec" ]]
		then
			echo "Command '$command' not found in $module" >&2
			echo "$usage" >&2
			exit 127
		else
			set -- "$command" "$@"
		fi
	fi

	if [[ $module != "version" ]]
	then
		"$AGB_LIBEXECDIR/version/version" "Agent Sandbox"
	fi

	export PATH="$AGB_LIBEXECDIR/$module:$PATH"

	exec "$exec" "$@"
}

main "$@"
