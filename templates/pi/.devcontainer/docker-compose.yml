# Pi Coding Agent Sandbox
#
# Works with both devcontainer (VS Code, JetBrains) and CLI usage.
# A .env file at the project root sets COMPOSE_FILE so that
# `docker compose` commands work from the project directory.
#
# CLI usage:
#   docker compose up -d
#   docker compose exec agent zsh
#   pi
#   docker compose down
#
# For reproducibility, pin images to a specific digest:
#   image: ghcr.io/mattolson/agent-sandbox-pi@sha256:<digest>
#   image: ghcr.io/mattolson/agent-sandbox-proxy@sha256:<digest>

services:
  proxy:
    image: ghcr.io/mattolson/agent-sandbox-proxy:latest
    environment:
      - PROXY_MODE=enforce
    volumes:
      - proxy-state:/home/mitmproxy/.mitmproxy
      - proxy-ca:/ca-export
      - ./policy.yaml:/etc/mitmproxy/policy.yaml:ro
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 3s
      retries: 3

  agent:
    image: ghcr.io/mattolson/agent-sandbox-pi:latest
    depends_on:
      proxy:
        condition: service_healthy
    # Required for iptables firewall setup. The agent runs as non-root and
    # sudoers only permits specific scripts, so it cannot modify iptables directly.
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      # Project workspace
      - ../:/workspace
      # Prevent agent from modifying compose, policy, or devcontainer config
      - .:/workspace/.devcontainer:ro
      # Persist Pi credentials and state
      - pi-state:/home/dev/.pi
      # Persist shell history
      - pi-history:/commandhistory
      # Proxy CA certificate (public cert only, no private key)
      - proxy-ca:/etc/mitmproxy:ro
      # Dotfiles (optional - auto-linked into $HOME at startup)
      # - ${HOME}/.config/agent-sandbox/dotfiles:/home/dev/.dotfiles:ro
      #
      # Shell customizations (optional - scripts sourced at shell startup)
      # - ${HOME}/.config/agent-sandbox/shell.d:/home/dev/.config/agent-sandbox/shell.d:ro
    working_dir: /workspace
    stdin_open: true
    tty: true
    environment:
      - TZ=${TZ:-America/Los_Angeles}
      - HTTP_PROXY=http://proxy:8080
      - HTTPS_PROXY=http://proxy:8080
      - NO_PROXY=localhost,127.0.0.1,proxy
      # Node.js: Trust mitmproxy CA certificate for HTTPS interception
      - NODE_EXTRA_CA_CERTS=/etc/mitmproxy/ca.crt
      # Disable HTTP/2 in Go clients (gh CLI) to avoid header validation issues through proxy
      - GODEBUG=http2client=0

volumes:
  pi-state:
  pi-history:
  proxy-state:
  proxy-ca:
